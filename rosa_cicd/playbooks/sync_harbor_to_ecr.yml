---
# Harbor to ECR Image Sync Playbook

- name: Sync Harbor Images to AWS ECR
  hosts: localhost
  connection: local
  gather_facts: no
  
  vars_files:
    - ../group_vars/rosa.yml
  
  tasks:
    # ========================================
    # 1. Harbor 로그인
    # ========================================
    - name: Login to Harbor Registry
      shell: echo "{{ harbor_password }}" | docker login "{{ harbor_url }}" --username "{{ harbor_username }}" --password-stdin
      register: harbor_login_shell
      changed_when: false
    
    # ========================================
    # 2. ECR 로그인
    # ========================================
    - name: Login to AWS ECR
      shell: |
        aws ecr get-login-password --region {{ aws_region }} | \
          docker login --username AWS --password-stdin {{ ecr_registry }}
      register: ecr_login
      changed_when: false
    
    # ========================================
    # 3. 이미지 동기화 (Pull -> Tag -> Push)
    # ========================================
    - name: Sync Images (Pull, Tag, Push)
      shell: |
        PUBLIC_IMG="{{ item.public_image | default('') }}"
        HARBOR_IMG="{{ item.harbor_image | default('') }}"
        
        if [ -n "$PUBLIC_IMG" ]; then
          # ========================================
          # Case A: Public Image (Docker Hub)
          # ========================================
          echo "Syncing from Docker Hub: $PUBLIC_IMG"
          docker pull $PUBLIC_IMG
          
          # Tag & Push to ECR
          docker tag $PUBLIC_IMG {{ ecr_registry }}/{{ item.image }}:latest
          docker push {{ ecr_registry }}/{{ item.image }}:latest
          
        elif [ -n "$HARBOR_IMG" ]; then
          # ========================================
          # Case B: Harbor Image (Private Registry)
          # ========================================
          
          # 1. Harbor에서 태그 목록 조회
          TAGS=$(curl -s -u "{{ harbor_username }}:{{ harbor_password }}" "http://{{ harbor_url }}/v2/$HARBOR_IMG/tags/list" | jq -r '.tags[]')
          
          if [ -z "$TAGS" ]; then
            echo "No tags found for $HARBOR_IMG"
            exit 1
          fi
          
          # 2. 버전 정렬하여 가장 최신 태그 선택
          SELECTED_TAG=$(echo "$TAGS" | sort -V | tail -n 1)
          echo "Auto-detected tag: $SELECTED_TAG"
          
          # 3. Pull from Harbor
          docker pull {{ harbor_url }}/$HARBOR_IMG:$SELECTED_TAG
          
          # 4. Tag for ECR
          docker tag {{ harbor_url }}/$HARBOR_IMG:$SELECTED_TAG {{ ecr_registry }}/{{ item.image }}:latest
          docker tag {{ harbor_url }}/$HARBOR_IMG:$SELECTED_TAG {{ ecr_registry }}/{{ item.image }}:$SELECTED_TAG
          
          # 5. Push to ECR
          docker push {{ ecr_registry }}/{{ item.image }}:latest
          docker push {{ ecr_registry }}/{{ item.image }}:$SELECTED_TAG
          
        else
          echo "Error: Neither public_image nor harbor_image defined for {{ item.name }}"
          exit 1
        fi
      loop: "{{ applications }}"
      # sync_only가 true이거나 기본값(false)일 때 모두 실행
      # (argocd role에서는 sync_only=true인 것을 제외하지만, 여기서는 모두 동기화해야 함... 
      #  잠깐, dr-worker는 sync_only=true인데 동기화 해야 함. 
      #  redis는 주석처리 했으므로 loop에 안 들어옴. OK.)
      register: sync_result
      # 에러 무시하지 않음 (실패 시 멈춤)
    
    # ========================================
    # 4. 결과 출력
    # ========================================
    - name: Display sync results
      debug:
        msg:
          - "========================================="
          - "Harbor to ECR Sync Complete!"
          - "========================================="
          - "Harbor: {{ harbor_url }}"
          - "ECR: {{ ecr_registry }}"
          - "Synced images:"
          - "{{ applications | map(attribute='name') | list }}"
          - "========================================="
