---
# Harbor to ECR Image Sync Playbook

- name: Sync Harbor Images to AWS ECR
  hosts: localhost
  gather_facts: no
  
  vars:
    harbor_url: "10.2.2.40:5000"
    harbor_project: "library"
    harbor_username: "admin"  # Harbor 사용자명
    harbor_password: "{{ lookup('env', 'HARBOR_PASSWORD') | default('Admin123') }}"  # 환경변수 또는 기본값
    aws_region: "ap-northeast-2"
    aws_account_id: "{{ lookup('pipe', 'aws sts get-caller-identity --query Account --output text') }}"
    ecr_registry: "{{ aws_account_id }}.dkr.ecr.{{ aws_region }}.amazonaws.com"
    
    # Harbor에서 가져올 이미지 목록 (실제 Harbor 리포지토리 기준)
    images_to_sync:
      - name: "library/oauth-api"
        ecr_repo: "production/oauth-api"
      - name: "library/web-v2-dashboard"
        ecr_repo: "production/web-v2-dashboard"
      - name: "library/integrated-dashboard"
        ecr_repo: "production/integrated-dashboard"
      - name: "library/map-api"
        ecr_repo: "production/map-api"
      - name: "library/energy-api"
        ecr_repo: "production/energy-api"
      - name: "library/my-web"
        ecr_repo: "production/my-web"
      - name: "library/kma-api"
        ecr_repo: "production/kma-api"
      - name: "library/dr-worker"
        ecr_repo: "production/dr-worker"
  
  tasks:
    # ========================================
    # 1. Harbor 로그인
    # ========================================
    - name: Login to Harbor Registry
      docker_login:
        registry_url: "{{ harbor_url }}"
        username: "{{ harbor_username }}"
        password: "{{ harbor_password }}"
        reauthorize: yes
      register: harbor_login
    
    # ========================================
    # 2. ECR 로그인
    # ========================================
    - name: Login to AWS ECR
      shell: |
        aws ecr get-login-password --region {{ aws_region }} | \
          docker login --username AWS --password-stdin {{ ecr_registry }}
      register: ecr_login
      changed_when: false
    
    # ========================================
    # 2. ECR 로그인
    # ========================================
    - name: Login to AWS ECR
      shell: |
        aws ecr get-login-password --region {{ aws_region }} | \
          docker login --username AWS --password-stdin {{ ecr_registry }}
      register: ecr_login
      changed_when: false
    
    # ========================================
    # 3. Harbor에서 이미지 Pull
    # ========================================
    - name: Pull images from Harbor
      docker_image:
        name: "{{ harbor_url }}/{{ item.name }}"
        source: pull
        force_source: yes
      loop: "{{ images_to_sync }}"
      register: harbor_pull
    
    # ========================================
    # 4. ECR용 태그 생성
    # ========================================
    - name: Tag images for ECR
      docker_image:
        name: "{{ harbor_url }}/{{ item.name }}"
        repository: "{{ ecr_registry }}/{{ item.ecr_repo }}"
        tag: latest
        source: local
        force_tag: yes
      loop: "{{ images_to_sync }}"
    
    # ========================================
    # 5. ECR로 Push
    # ========================================
    - name: Push images to ECR
      docker_image:
        name: "{{ ecr_registry }}/{{ item.ecr_repo }}"
        tag: latest
        push: yes
        source: local
      loop: "{{ images_to_sync }}"
      register: ecr_push
    
    # ========================================
    # 6. 로컬 이미지 정리 (선택)
    # ========================================
    - name: Clean up local images
      docker_image:
        name: "{{ harbor_url }}/{{ item.name }}"
        state: absent
      loop: "{{ images_to_sync }}"
      when: cleanup_local_images | default(false)
    
    # ========================================
    # 7. 결과 출력
    # ========================================
    - name: Display sync results
      debug:
        msg:
          - "========================================="
          - "Harbor to ECR Sync Complete!"
          - "========================================="
          - "Harbor: {{ harbor_url }}"
          - "ECR: {{ ecr_registry }}"
          - "Synced {{ images_to_sync | length }} images"
          - "========================================="
