---
# Harbor to ECR Image Sync Playbook

- name: Sync Harbor Images to AWS ECR
  hosts: localhost
  connection: local
  gather_facts: no
  
  # 변수는 group_vars/rosa.yml에서 가져옵니다.
  # 실행 예시: export HARBOR_PASSWORD=...; ansible-playbook playbooks/sync_harbor_to_ecr.yml
  
  tasks:
    # ========================================
    # 1. Harbor 로그인
    # ========================================
    - name: Login to Harbor Registry
      docker_login:
        registry_url: "{{ harbor_url }}"
        username: "{{ harbor_username }}"
        password: "{{ harbor_password }}"
        reauthorize: yes
      register: harbor_login
    
    # ========================================
    # 2. ECR 로그인
    # ========================================
    - name: Login to AWS ECR
      shell: |
        aws ecr get-login-password --region {{ aws_region }} | \
          docker login --username AWS --password-stdin {{ ecr_registry }}
      register: ecr_login
      changed_when: false
    
    # ========================================
    # 3. Harbor에서 이미지 Pull
    # ========================================
    - name: Pull images from Harbor
      docker_image:
        name: "{{ harbor_url }}/{{ item.harbor_image }}"
        source: pull
        force_source: yes
      loop: "{{ applications }}"
      register: harbor_pull
    
    # ========================================
    # 4. ECR용 태그 생성
    # ========================================
    - name: Tag images for ECR
      docker_image:
        name: "{{ harbor_url }}/{{ item.harbor_image }}"
        repository: "{{ ecr_registry }}/{{ item.image }}"
        tag: latest
        source: local
        force_tag: yes
      loop: "{{ applications }}"
    
    # ========================================
    # 5. ECR로 Push
    # ========================================
    - name: Push images to ECR
      docker_image:
        name: "{{ ecr_registry }}/{{ item.image }}"
        tag: latest
        push: yes
        source: local
      loop: "{{ applications }}"
      register: ecr_push
    
    # ========================================
    # 6. 로컬 이미지 정리 (선택)
    # ========================================
    - name: Clean up local images
      docker_image:
        name: "{{ harbor_url }}/{{ item.harbor_image }}"
        state: absent
      loop: "{{ applications }}"
      when: cleanup_local_images | default(false)
    
    # ========================================
    # 7. 결과 출력
    # ========================================
    - name: Display sync results
      debug:
        msg:
          - "========================================="
          - "Harbor to ECR Sync Complete!"
          - "========================================="
          - "Harbor: {{ harbor_url }}"
          - "ECR: {{ ecr_registry }}"
          - "Synced {{ applications | length }} images"
          - "========================================="
