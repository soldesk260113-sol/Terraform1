---
# ArgoCD Installation Role

- name: Create ArgoCD Namespace
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: "{{ argocd_namespace }}"

- name: Install ArgoCD
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition: "{{ lookup('url', 'https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml') }}"

- name: Wait for ArgoCD Server
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig }}"
    kind: Deployment
    namespace: "{{ argocd_namespace }}"
    name: argocd-server
  register: argocd_server
  until: argocd_server.resources[0].status.readyReplicas | default(0) > 0
  retries: 30
  delay: 10

- name: Create ArgoCD Applications
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig }}"
    state: present
    definition: "{{ lookup('template', 'application.yml.j2') }}"
  loop: "{{ applications }}"
  when: not item.sync_only | default(false)
